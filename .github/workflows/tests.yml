name: FluidLoom Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-22.04

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          ninja-build \
          git \
          liblua5.4-dev \
          libssl-dev \
          libvulkan-dev \
          libvulkan1 \
          libvulkan-1.so.1 \
          vulkan-tools \
          vulkan-validationlayers \
          vulkan-validationlayers-dev \
          ca-certificates \
          mesa-vulkan-drivers \
          libxcb-randr0 \
          libxcb-xfixes0 \
          libxcb-xkb1 \
          libxkbcommon-x11-0

    - name: Verify Vulkan installation
      run: |
        echo "=== Vulkan Tools ==="
        vulkaninfo --summary 2>&1 | head -30 || echo "vulkaninfo available"
        echo ""
        echo "=== Vulkan Libraries ==="
        ldconfig -p | grep vulkan || echo "Vulkan libraries:"
        ls -la /usr/lib/x86_64-linux-gnu/ | grep -i vulkan || true
        echo ""
        echo "=== Environment ==="
        echo "VK_DRIVER_FILES=${VK_DRIVER_FILES:-not set}"
        echo "VK_ICD_FILENAMES=${VK_ICD_FILENAMES:-not set}"

    - name: Create build directory
      run: mkdir -p build

    - name: Configure CMake
      working-directory: build
      run: |
        cmake .. \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_CXX_STANDARD=20 \
          -GNinja

    - name: Build
      working-directory: build
      run: |
        echo "Starting build..."
        ninja -v 2>&1 | tee build.log
        if [ ${PIPESTATUS[0]} -ne 0 ]; then
          echo "Build failed! Last 100 lines of output:"
          tail -100 build.log
          exit 1
        fi

    - name: Run Tests
      working-directory: build
      run: |
        echo "Running test suite on Linux with Vulkan support..."
        echo "Expected: 28/28 tests should pass (all GPU tests supported on Linux)"
        echo ""

        # Set up Vulkan environment variables
        export VK_INSTANCE_LAYERS=""  # No validation layers in CI

        # Run tests with verbose output
        ./tests/fluidloom_tests -s 2>&1 | tee test-output.log
        exit_code=${PIPESTATUS[0]}

        echo ""
        echo "Test execution completed with exit code: $exit_code"

        if [ $exit_code -ne 0 ]; then
          echo ""
          echo "❌ Tests failed!"
          echo "Last 100 lines of output:"
          tail -100 test-output.log
        else
          echo ""
          echo "✅ All tests passed!"
        fi
        exit $exit_code
      continue-on-error: false

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: test-results
        path: build/test-results.txt
        retention-days: 30

  code-quality:
    runs-on: ubuntu-22.04

    steps:
    - uses: actions/checkout@v4

    - name: Run clang-format check
      run: |
        sudo apt-get update
        sudo apt-get install -y clang-format
        find src include tests \( -name "*.cpp" -o -name "*.hpp" \) -print0 | while IFS= read -r -d '' file; do
          if ! clang-format --dry-run --Werror "$file" > /dev/null 2>&1; then
            echo "❌ Formatting issue in $file"
            exit 1
          fi
        done
        echo "✅ All files properly formatted"
      continue-on-error: true
