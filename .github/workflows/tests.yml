name: FluidLoom Tests

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main, develop ]

jobs:
  test:
    runs-on: ubuntu-22.04

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          ninja-build \
          git \
          liblua5.4-dev \
          libssl-dev \
          libvulkan-dev \
          libvulkan1 \
          vulkan-tools \
          vulkan-validationlayers \
          ca-certificates

    - name: Create build directory
      run: mkdir -p build

    - name: Configure CMake
      working-directory: build
      run: |
        cmake .. \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_CXX_STANDARD=20 \
          -GNinja

    - name: Build
      working-directory: build
      run: |
        echo "Starting build..."
        ninja -v 2>&1 | tee build.log
        if [ ${PIPESTATUS[0]} -ne 0 ]; then
          echo "Build failed! Last 100 lines of output:"
          tail -100 build.log
          exit 1
        fi

    - name: Run Tests
      working-directory: build
      run: |
        echo "Running test suite..."
        ./tests/fluidloom_tests -s 2>&1 | tee test-output.log
        exit_code=${PIPESTATUS[0]}
        if [ $exit_code -ne 0 ]; then
          echo "Tests failed with exit code: $exit_code"
          echo "Last 50 lines of output:"
          tail -50 test-output.log
        fi
        exit $exit_code
      continue-on-error: false

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: test-results
        path: build/test-results.txt
        retention-days: 30

  code-quality:
    runs-on: ubuntu-22.04

    steps:
    - uses: actions/checkout@v4

    - name: Run clang-format check
      run: |
        sudo apt-get update
        sudo apt-get install -y clang-format
        find src include tests \( -name "*.cpp" -o -name "*.hpp" \) -print0 | while IFS= read -r -d '' file; do
          if ! clang-format --dry-run --Werror "$file" > /dev/null 2>&1; then
            echo "❌ Formatting issue in $file"
            exit 1
          fi
        done
        echo "✅ All files properly formatted"
      continue-on-error: true
